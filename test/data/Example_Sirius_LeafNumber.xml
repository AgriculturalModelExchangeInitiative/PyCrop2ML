<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE ModelUnit PUBLIC "-//SIMPLACE/DTD SOL 1.0//EN" "https://github.com/AgriculturalModelExchangeInitiative/PyCropML/tree/version2/test/data/ModelUnit.dtd">
<ModelUnit modelid="1" name="CalculateLeafNumber" timestep="1" version="1.0">
    <Description>
        <Title>CalculateLeafNumber Model</Title>
        <Authors>Pierre MARTRE</Authors>
        <Institution>INRA Montpellier</Institution>
        <Reference>absolutely non</Reference>
        <Abstract>calculate leaf number. LeafNumber increase is caped at one more leaf per day</Abstract>
    </Description>
    <Inputs>
        <Input name="DeltaTT" description="daily delta TT . It is the same kind of TT as cumulTT[0]" parametercategory="species" datatype="DOUBLE" min="0" max="100" default="80" unit="°Cd" uri="some url" inputtype="variable"/>
        <Input name="Phyllochron" description=" " parametercategory="species" inputtype ="variable" datatype="DOUBLE" min="0" max="25" default="0" unit="°Cd/leaf" uri="some url"/>
        <Input name="HasFlagLeafLiguleAppeared" description="true if flag leaf has appeared (leafnumber reached finalLeafNumber)" parametercategory="species" datatype="INT" min="0" max="1" default="0" unit="unitless" uri="some url" inputtype = "variable"/>
        <Input name="SwitchMaize" description="true if maize" parametercategory="constant" datatype="INT" min="0" max="1" default="0" unit="unitless" uri="some url" inputtype = "parameter"/>
        <Input name="atip" description="slope of leaf initiation" parametercategory="species" datatype="DOUBLE" min="0" max="1000" default="10" unit="leaf/°Cday²" uri="some url" inputtype = "parameter"/>
        <Input name="Leaf_tip_emerg" description="parameter for maize number of tip emerged" parametercategory="species" datatype="DOUBLE" min="0" max="1000" default="10" unit="unitless" uri="some url" inputtype = "parameter"/>
        <Input name="k_bl" description="" parametercategory="constant" inputtype="parameter" datatype="DOUBLE" min="0" max="100" default="1.412" unit="unitless" uri="some url"/>
        <Input name="Nlim" description="" parametercategory="constant" datatype="DOUBLE" default="6.617" min="0" max="1000" unit="unitless" uri="some url" inputtype="parameter"/>
        <Input name="LeafNumber" description=" Actual number of phytomers" datatype="DOUBLE" min="0" max="25" default="0"  unit="leaf" uri="some url" inputtype="variable"/>
        <Input name="cumulTTPhenoMaizeAtEmergence" description="cumulTTPhenoMaizeAtEmergence" datatype="DOUBLE" min="0" max="10000" default="300"  unit="°C" uri="some url"/>
        <Input name="cumulTT" description="cumulTT" datatype="DOUBLEARRAY" min="0" max="10000"  unit="°C" default="[80,200,300,400,500,600,900]" uri="some url"/>
		<Input name="Ntip" description="Maize number of tip" datatype="DOUBLE" min="0" max="10000"  unit="leaf" default="0" uri="some url"/>
    
    </Inputs>
    <Outputs>
        <Output name="LeafNumber" description="Actual number of phytomers" datatype="DOUBLE" min="0" max="10000"  unit="leaf" uri="some url"/>
        <Output name="Ntip" description="Maize number of tip" datatype="DOUBLE" min="0" max="10000"  unit="leaf" uri="some url"/>
  	
    </Outputs>
    <Algorithm language="Python_ext"><![CDATA[
		LeafNumber1 = LeafNumber
		if (HasFlagLeafLiguleAppeared==0):
		{        
			if (SwitchMaize==0):
			{            
				if (Phyllochron == 0.0):
				{               
					Phyllochron = 0.0000001
				}
            
				LeafNumber = LeafNumber1 + min(DeltaTT / Phyllochron, 0.999)
			}
			else:
			{
				if (LeafNumber1 < Leaf_tip_emerg):
			
				{                
					LeafNumber = Leaf_tip_emerg
				}
            
				else:
				{
					nextstartExpTT = 0
					nexttipTT= ((LeafNumber1 + 1) - Leaf_tip_emerg) / atip + cumulTTPhenoMaizeAtEmergence
					abl = k_bl * atip;
					tt_lim_lip = ((Nlim - Leaf_tip_emerg) / atip) + cumulTTPhenoMaizeAtEmergence
					bbl = Nlim - (abl * tt_lim_lip);
					tt_bl = ((LeafNumber1 + 1) - bbl) / abl
					if (tt_bl > nexttipTT):
					{
                    
						nextstartExpTT = nexttipTT
					}
                
					else:
					{
                    
					nextstartExpTT = tt_bl
					}
                
					if (cumulTT[6] >= nextstartExpTT) :
					{
                    
					LeafNumber = LeafNumber1 + 1
					}
                
					else:
					{
                    
					LeafNumber = LeafNumber1
					}
            
				}    
            
				Ntip = atip * (cumulTT[6] - cumulTTPhenoMaizeAtEmergence) + Leaf_tip_emerg;
			}
		}
			]]>
     </Algorithm>
     <Parametersets>
        <Parameterset name="wheat" description="some values in there" >
        	<Param name="SwitchMaize">0</Param>
        	<Param name="Leaf_tip_emerg">5</Param>

        </Parameterset>

        <Parameterset name="maize" description="some values in there" >
           <Param name="SwitchMaize">1</Param>
           <Param name="Leaf_tip_emerg">5</Param>

        </Parameterset>
     </Parametersets>
     <Testsets>
        <Testset name="check wheat model1" parameterset = "wheat" description="some values in there" >
        	<Test name ="test_wheat1">
        		<InputValue name="LeafNumber">4</InputValue>
        		<InputValue name="Phyllochron">0</InputValue>
        		<OutputValue name="Ntip" precision ="2">0</OutputValue>
				<OutputValue name="LeafNumber" precision ="2">5</OutputValue>
        	
        	</Test>
        	<Test name ="test_wheat2">
        		<InputValue name="LeafNumber">15</InputValue>
        		<InputValue name="Phyllochron">4</InputValue>
				<OutputValue name="Ntip" precision ="2">0</OutputValue>
				<OutputValue name="LeafNumber" precision ="2">16</OutputValue>
        	</Test>
        </Testset>
        <Testset name="check wheat model2" parameterset = "maize" description="some values in there" >
        	<Test name ="test_maize">
        		<InputValue name="LeafNumber">10</InputValue>
        		<InputValue name="Phyllochron">4</InputValue>
				<OutputValue name="Ntip" precision ="2">6005</OutputValue>
				<OutputValue name="LeafNumber" precision ="2">11</OutputValue>
        	</Test>
        </Testset>
      </Testsets>
 	
</ModelUnit>
